<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.visolink.salesmanage.onlineretailersuse.dao.OnlineretailersUseDao">

    <select id="getOnlineretailersUseApplayList" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT
        a.policy_name AS title,
        a.id AS json_id,
        mi.business_unit_name,
        mi.project_name,
        DATE_FORMAT( flow.zddate, '%Y-%m-%d' ) zddate,
        (
        CASE
        flow_status
        WHEN 1 THEN
        '未发起'
        WHEN 2 THEN
        '草稿'
        WHEN 3 THEN
        '审批中'
        WHEN 4 THEN
        '审批通过'
        WHEN 5 THEN
        '驳回发起'
        WHEN 6 THEN
        '撤回发起'
        WHEN 7 THEN
        '流程废弃'
        END
        ) flow_status,
        flow.flow_status AS flow_statusCode,
        a.creator_name AS EmployeeName,
        flow.flow_id
        FROM
        cm_policy a
        LEFT JOIN mm_ap_flow_info flow ON flow.json_id = a.id
        INNER JOIN mm_idm_business_unit_project_rel mi ON mi.project_id = a.project_id
        LEFT JOIN policy_org_rel p ON a.id = p.biz_id
        WHERE
        a.policy_type = 3
        AND
        CASE
        WHEN #{orgId} IS NULL THEN TRUE ELSE  p.org_id IN
        (
        SELECT DISTINCT
        orgId
        FROM
        `s_jobsorgrel`
        WHERE
        CASE
        WHEN #{orgLevel} = 1 THEN groupOrgId = #{orgId}

        WHEN #{orgLevel} = 2 THEN areaOrgId = #{orgId}

        WHEN #{orgLevel} = 3 THEN cityOrgId = #{orgId}

        WHEN #{orgLevel} = 4 THEN projectOrgId = #{orgId} ELSE FALSE END) END
        <if test="flow_status!=null and flow_status!=''">
            and flow.flow_status =#{flow_status}
        </if>
        <if test="title!=null and title!=''">
            and a.policy_name like CONCAT("%",#{title},"%")
        </if>
        ORDER BY a.create_time desc
        LIMIT  #{pageIndex},#{pageSize}
    </select>
    <select id="getOnlineretailersUseApplayCount" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT
        a.policy_name AS title,
        a.id AS json_id,
        mi.business_unit_name,
        mi.project_name,
        DATE_FORMAT( flow.zddate, '%Y-%m-%d' ) zddate,
        (
        CASE
        flow_status
        WHEN 1 THEN
        '未发起'
        WHEN 2 THEN
        '草稿'
        WHEN 3 THEN
        '审批中'
        WHEN 4 THEN
        '审批通过'
        WHEN 5 THEN
        '驳回发起'
        WHEN 6 THEN
        '撤回发起'
        WHEN 7 THEN
        '流程废弃'
        END
        ) flow_status,
        flow.flow_status AS flow_statusCode,
        a.creator_name AS EmployeeName,
        flow.flow_id
        FROM
        cm_policy a
        LEFT JOIN mm_ap_flow_info flow ON flow.json_id = a.id
        INNER JOIN mm_idm_business_unit_project_rel mi ON mi.project_id = a.project_id
        LEFT JOIN policy_org_rel p ON a.id = p.biz_id
        WHERE
        a.policy_type = 3
        AND
        CASE
        WHEN #{orgId} IS NULL THEN TRUE ELSE  p.org_id IN
        (
        SELECT DISTINCT
        orgId
        FROM
        `s_jobsorgrel`
        WHERE
        CASE
        WHEN #{orgLevel} = 1 THEN groupOrgId = #{orgId}

        WHEN #{orgLevel} = 2 THEN areaOrgId = #{orgId}

        WHEN #{orgLevel} = 3 THEN cityOrgId = #{orgId}

        WHEN #{orgLevel} = 4 THEN projectOrgId = #{orgId} ELSE FALSE END) END
        <if test="flow_status!=null and flow_status!=''">
            and flow.flow_status =#{flow_status}
        </if>
        <if test="title!=null and title!=''">
            and a.policy_name like CONCAT("%",#{title},"%")
        </if>
        ORDER BY a.create_time desc
    </select>
    <insert id="saveOnlineretailersUseApplay" parameterType="java.util.Map" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Nov 26 21:43:25 CST 2020.
        -->
        insert into mm_onlineretailers_use
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                id,
            </if>
            <if test="applicant != null">
                applicant,
            </if>
            <if test="project_id != null">
                project_id,
            </if>
            <if test="project_name != null">
                project_name,
            </if>
            <if test="stage_name != null">
                stage_name,
            </if>
            <if test="stage_id != null">
                stage_id,
            </if>
            <if test="post_name!=null">
                post_name,
            </if>
            <if test="matter != null">
                matter,
            </if>
            <if test="commerce_company != null">
                commerce_company,
            </if>
            <if test="commerce_id != null">
                commerce_id,
            </if>
            create_time,
            <if test="creator != null">
                creator,
            </if>
            <if test="update_time != null">
                update_time,
            </if>
            <if test="title != null">
                title,
            </if>
            <if test="app_explan != null" >
                app_explan,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                #{id,jdbcType=VARCHAR},
            </if>
            <if test="applicant != null">
                #{applicant,jdbcType=VARCHAR},
            </if>
            <if test="project_id != null">
                #{project_id,jdbcType=VARCHAR},
            </if>
            <if test="project_name != null">
                #{project_name,jdbcType=VARCHAR},
            </if>
            <if test="stage_name != null">
                #{stage_name},
            </if>
            <if test="stage_id != null">
                #{stage_id},
            </if>
            <if test="post_name!=null">
                #{post_name},
            </if>
            <if test="matter != null">
                #{matter,jdbcType=VARCHAR},
            </if>
            <if test="commerce_company != null">
                #{commerce_company,jdbcType=VARCHAR},
            </if>
            <if test="commerce_id != null">
                #{commerce_id},
            </if>
            NOW(),
            <if test="creator != null">
                #{creator,jdbcType=VARCHAR},
            </if>
            <if test="update_time != null">
                #{update_time,jdbcType=TIMESTAMP},
            </if>
            <if test="title != null">
                #{title,jdbcType=LONGVARCHAR},
            </if>
            <if test="app_explan != null" >
                #{app_explan,jdbcType=LONGVARCHAR},
            </if>
        </trim>
    </insert>
    <insert id="saveOnlineretailersUseItem" parameterType="java.util.Map" >
        insert into mm_onlineretailers_item
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="stage_id!=null">
                stage_id,
            </if>
            <if test="stage_name!=null">
                stage_name,
            </if>
            <if test="product_name != null">
                product_name,
            </if>
            <if test="product_id != null">
                product_id,
            </if>
            <if test="build_id != null">
                build_id,
            </if>
            <if test="build_name != null">
                build_name,
            </if>
            <if test="house_type != null">
                house_type,
            </if>
            <if test="house_id != null">
                house_id,
            </if>
            <if test="money != null and money!=''">
                money,
            </if>
            <if test="policyName != null">
                policyName,
            </if>
            <if test="policyValue != null">
                policyValue,
            </if>
            <if test="name != null">
                name,
            </if>
            <if test="value != null">
                value,
            </if>
            <if test="cycle_start != null">
                cycle_start,
            </if>
            <if test="cycle_end != null">
                cycle_end,
            </if>
            create_time,
            <if test="base_id != null">
                base_id,
            </if>
            <if test="order_num!=null">
                order_num,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=VARCHAR},
            </if>
            <if test="stage_id!=null">
                #{stage_id},
            </if>
            <if test="stage_name!=null">
                #{stage_name},
            </if>
            <if test="product_name != null">
                #{product_name},
            </if>
            <if test="product_id != null">
                #{product_id},
            </if>
            <if test="build_id != null">
                #{build_id},
            </if>
            <if test="build_name != null">
                #{build_name},
            </if>
            <if test="house_type != null">
                #{house_type},
            </if>
            <if test="house_id != null">
                #{house_id},
            </if>
            <if test="money != null and money!=''">
                #{money,jdbcType=DECIMAL},
            </if>
            <if test="policyName != null">
                #{policyName},
            </if>
            <if test="policyValue != null">
                #{policyValue},
            </if>
            <if test="name != null">
                #{name,jdbcType=VARCHAR},
            </if>
            <if test="value != null">
                #{value,jdbcType=VARCHAR},
            </if>
            <if test="cycle_start != null">
                #{cycle_start},
            </if>
            <if test="cycle_end != null">
                #{cycle_end},
            </if>
            NOW(),
            <if test="base_id != null">
                #{base_id,jdbcType=VARCHAR},
            </if>
            <if test="order_num!=null">
                #{order_num},
            </if>
        </trim>
    </insert>
    <update id="updateOnlineretailersUseApplay" parameterType="java.util.Map" >

        update mm_onlineretailers_use
        <set>
            <if test="applicant != null">
                applicant = #{applicant,jdbcType=VARCHAR},
            </if>
            <if test="project_id != null">
                project_id = #{project_id,jdbcType=VARCHAR},
            </if>
            <if test="project_name != null">
                project_name = #{project_name,jdbcType=VARCHAR},
            </if>
            <if test="stage_id != null">
                stage_id = #{stage_id,jdbcType=VARCHAR},
            </if>
            <if test="stage_name != null">
                stage_name = #{stage_name,jdbcType=VARCHAR},
            </if>
            <if test="post_name!=null">
                post_name=#{post_name},
            </if>
            <if test="matter != null">
                matter = #{matter,jdbcType=VARCHAR},
            </if>
            <if test="commerce_company != null">
                commerce_company = #{commerce_company,jdbcType=VARCHAR},
            </if>
            <if test="commerce_id != null">
                commerce_id = #{commerce_id,jdbcType=VARCHAR},
            </if>
            update_time =NOW(),
            <if test="title != null">
                title = #{title,jdbcType=LONGVARCHAR},
            </if>
            <if test="app_explan != null">
                app_explan = #{app_explan,jdbcType=LONGVARCHAR},
            </if>
        </set>
      WHERE id=#{BOID}
    </update>

    <delete id="clearItemData" parameterType="java.lang.String">
        DELETE FROM mm_onlineretailers_item WHERE base_id=#{BOID}
    </delete>

    <!--查询业务主数据-->
    <select id="getOnlineretailersMainData" resultType="java.util.Map" parameterType="java.util.Map">
SELECT
id,
title,
applicant,
post_name,
project_id,
project_name,
stage_id,
stage_name,
matter,
commerce_company,
commerce_id,
app_explan,
DATE_FORMAT(create_time, '%Y-%m-%d' ) create_time
FROM mm_onlineretailers_use
WHERE id=#{BOID}
    </select>
    <!--查询业务附属数据-->
    <select id="getOnlineretailersItemData" resultType="java.util.Map" parameterType="java.util.Map">
SELECT
stage_id,
stage_name,
product_name,
product_id,
build_id,
build_name,
house_type,
house_id,
money,
policyName,
policyValue,
name,
value,
DATE_FORMAT(cycle_start,'%Y-%m-%d') as cycle_start,
DATE_FORMAT(cycle_end,'%Y-%m-%d') as cycle_end
FROM mm_onlineretailers_item
WHERE base_id=#{BOID}
ORDER BY order_num
    </select>

    <select id="getOnlineretailersCompanyList" resultType="java.util.Map">
SELECT
	`name`,
	id
FROM
	cm_non_project_pur
WHERE
	categorys LIKE '%电商服务%'
GROUP BY
	id
    </select>

    <!-- 将销售政策数据添加到政策主表 -->
    <insert id="insertCmPolicySalesForOnlineretailers" parameterType="java.util.Map">
        insert into cm_policy
        (id,policy_name,project_id,project_name,status,
        create_time,creator_name,creator,
        policy_type,isDel,
        job_org_id,job_id,org_id)
        value(#{id},#{item_name},#{project_id},#{project_name},1,
        now(),#{applicant_name},#{creator},
        3,0,
        #{job_org_id},#{job_id},#{org_id})
    </insert>

    <select id="getOnlineretailersItemDataForMy" resultType="java.util.Map" parameterType="java.util.Map">
SELECT
stage_id as projGuid,
product_id as productTypeId,
build_id as bldIds,
build_name as bldNames,
house_id as hxIds,
house_type as hxNames,
money as sqAmount,
CASE policyName
	WHEN '打折' THEN
		'0'
		WHEN '总价优惠' THEN
		'1'
		WHEN '单价优惠' THEN
		'2'
	ELSE
		'3'
END AS calMethod,
IFNULL(policyValue,0.00) as discountValue,
CASE name
	WHEN '比例' THEN
		'1'
	ELSE
		'0'
END AS serviceType,
`value` as serviceData,
DATE_FORMAT(cycle_start,'%Y-%m-%d') as startDate,
DATE_FORMAT(cycle_end,'%Y-%m-%d') as endDate
FROM mm_onlineretailers_item
WHERE base_id=#{BOID}
    </select>


    <insert id="insertParamLogForPushSystem" parameterType="java.lang.String">
        insert into log
        (id,create_time,description,params)
        values(
        uuid(),now(),#{description},#{params}
        )
    </insert>

    <select id="getUserName" resultType="java.lang.String" parameterType="java.lang.String">
        SELECT userName FROM b_account where id=#{userId}
    </select>

    <delete id="deleteMainData" parameterType="java.lang.String">
        DELETE FROM mm_onlineretailers_use WHERE id=#{BOID};
        DELETE FROM cm_policy WHERE id=#{BOID};
        DELETE FROM policy_org_rel WHERE biz_id=#{BOID};
        DELETE FROM mm_ap_flow_info WHERE json_id=#{BOID};
    </delete>

</mapper>
